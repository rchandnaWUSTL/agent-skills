{
  "enabled": true,
  "name": "Create New Action Spec",
  "description": "Scaffolds a new Terraform action spec with standard structure and templates",
  "version": "4",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "Create a new Terraform action spec following the guidance in `.kiro/steering/actions.md`.\n\n**IMPORTANT**: Reference `.kiro/steering/actions.md` for all technical details, patterns, and examples. The steering doc is the source of truth.\n\n**Step 1: Gather Information**\nAsk the user for:\n1. Action name (e.g., \"aws_lambda_invoke\", \"aws_dynamodb_create_backup\")\n2. Brief description of what the action does (1-2 sentences)\n3. Primary AWS service (e.g., Lambda, DynamoDB, SSM, S3)\n4. Action pattern type (refer to \"Common Action Patterns\" in steering doc)\n5. **Official AWS API documentation URL** (e.g., https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_CreateBackup.html)\n   - This is CRITICAL for accurate implementation\n   - Fetch and reference the official documentation to ensure:\n     - Correct API parameters and their requirements (required vs optional)\n     - Accurate parameter validation rules (length, patterns, formats)\n     - Complete list of possible error types\n     - API rate limits and constraints\n     - Correct response structure\n     - **Service-specific prerequisites** (e.g., DynamoDB requires point-in-time recovery enabled)\n\n**Step 2: Fetch Official Documentation**\nUse the mcp_fetch_fetch tool to retrieve the official AWS API documentation.\n- Fetch the primary API operation documentation (e.g., CreateBackup)\n- Fetch related API operations if needed (e.g., DescribeBackup for polling)\n- Extract and note:\n  - Required vs optional parameters\n  - Parameter validation rules (length, patterns)\n  - All possible error types and their meanings\n  - API rate limits\n  - Response structure\n  - Service-specific prerequisites or requirements\n\n**Step 3: Create Directory Structure**\nCreate: `.kiro/specs/<action-name>-action/`\n\n**Step 4: Generate requirements.md**\nFollow the \"Requirements Document Structure\" section in `.kiro/steering/actions.md`.\n\nCreate a requirements document with:\n- **Introduction**: Explain the action's purpose and AWS integration\n- **Glossary (REQUIRED)**: Follow glossary guidance in steering doc\n  - Action-specific terms\n  - AWS service concepts\n  - Terraform framework terms\n  - Domain-specific language\n- **User Stories (4-6)**: Cover the key areas listed in steering doc\n  - Basic operation\n  - Parameter handling\n  - Error handling\n  - Timeout configuration\n  - Progress reporting\n  - Output/result handling\n- Each user story must follow EARS patterns with 3-5 acceptance criteria\n- **Document service prerequisites** if any (e.g., PITR for DynamoDB backups)\n\n**Step 5: Generate design.md**\nFollow the \"Design Document Structure\" section in `.kiro/steering/actions.md`.\n\nInclude ALL required sections from steering doc:\n- **Overview**: Purpose and use cases\n- **Architecture**: Flow diagrams (mermaid), component structure\n- **Components and Interfaces**: Action structure, schema, AWS SDK integration\n- **Data Models**: Schema in table format (see steering doc for example)\n- **Error Handling**: All AWS error types (see steering doc for pattern)\n- **Design Decisions and Rationales (REQUIRED)**: See steering doc for framework\n- **Security Considerations (REQUIRED)**: See steering doc for template\n- **Performance Considerations (REQUIRED)**: See steering doc for template\n- **Dependencies (REQUIRED)**: List all packages with import paths\n- **Testing Strategy**: Test scenarios and sweep functions\n- **Implementation Details**: Polling (actionwait), validation, progress\n- **Future Enhancements (OPTIONAL)**: Out of scope items\n\n**CRITICAL**: For schema implementation, polling patterns, error handling, and all technical details, refer to the corresponding sections in `.kiro/steering/actions.md`.\n\n**Step 6: Generate tasks.md**\nCreate implementation tasks following the patterns in steering doc.\n\nInclude tasks for:\n1. Core action structure (see steering doc for file structure)\n2. Schema implementation (see steering doc for schema guidance)\n3. Helper functions\n4. Core Invoke method\n5. Main operation\n6. Status polling (use actionwait - see steering doc for examples)\n7. Documentation (see steering doc for documentation standards)\n8. Tests (see steering doc for test patterns)\n   - Note: before_destroy/after_destroy not supported in Terraform 1.14.0\n   - Include service prerequisites in test configurations\n   - Use multi-region pattern if testing region parameter\n9. Sweep function (see steering doc for sweep function guidance)\n10. Changelog entry (see steering doc for format)\n\nEach task must:\n- Reference requirements\n- Include specific file paths\n- Note common pitfalls from steering doc\n\nInclude the pre-submission checklist from steering doc.\n\n**Step 7: Reference Existing Actions**\nUse the examples listed in `.kiro/steering/actions.md` under \"Common Action Patterns\".\n\nFor the selected pattern, reference:\n- Code implementation example\n- Documentation example\n- Spec example (if available)\n\n**Excellent Reference Spec:**\n- `.kiro/specs/aws_dynamodb_create_backup-action/` - Complete example with all sections and implementation findings\n\n**Step 8: Validate**\nAfter creating all files, verify against steering doc requirements:\n- Requirements have comprehensive glossary\n- Requirements document service prerequisites\n- Design has all required sections (decisions, security, performance, dependencies)\n- Design includes mermaid diagrams\n- Schema uses correct types (fwtypes - see steering doc)\n- Tasks include sweep function and actionwait (if needed)\n- Tasks note Terraform 1.14.0 limitations (no before/after_destroy)\n- Tasks include service prerequisites in test configs\n- Tasks include pre-submission checklist from steering doc\n\n**Step 9: Provide Summary**\nCreate a summary including:\n- Action name and pattern type\n- Number of requirements/user stories\n- Key design decisions documented\n- Service prerequisites identified\n- Number of implementation tasks\n- Files created\n- Whether polling/sweep functions are needed\n- Terraform version limitations noted\n- Link to steering doc sections used\n\n**IMPORTANT LEARNINGS:**\n\n**Terraform 1.14.0 Limitations:**\n- Only 4 lifecycle events supported: before_create, after_create, before_update, after_update\n- before_destroy and after_destroy are NOT supported (will cause validation errors)\n- Document this in requirements if action is intended for destruction workflows\n\n**Service Prerequisites:**\n- Always check AWS documentation for service-specific prerequisites\n- Example: DynamoDB backups require point-in-time recovery enabled on tables\n- Document prerequisites in requirements, design, and test configurations\n- Include prerequisite setup in all test table/resource configurations\n\n**Testing Best Practices:**\n- Duplicate name/resource tests don't apply to lifecycle-triggered actions\n- Multi-region tests require ConfigMultipleRegionProvider(2) and ProtoV5FactoriesMultipleRegions\n- Error patterns need (?s) flag for multi-line matching: regexache.MustCompile(`(?s)Error.*phrase`)\n- Test execution requires: export TF_ACC_TERRAFORM_PATH=/tmp/terraform\n- Some test patterns (duplicate operations) don't work with lifecycle triggers\n\n**NOTE**: For all technical implementation details, code examples, patterns, and best practices, refer the user to `.kiro/steering/actions.md`. The steering doc is the authoritative source."
  }
}
